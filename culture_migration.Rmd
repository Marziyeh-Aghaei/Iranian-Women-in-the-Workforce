<<<<<<< HEAD
---
  title: "culture_migration"
author: "Marziyeh Aghaei"
date: "2024-07-22"
output:
  html_document: 
  code_folding: show
   number_sections: yesS
   toc: yes
   toc_depth: 2
   toc_float: yes
---
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r,message = FALSE}
# packages
require(tidyverse)
require(fixest)
require(stargazer)
require(haven)
library(usethis)
library(dplyr)
library(foreign)
library(gridExtra)
library(ggplot2)
library(openxlsx)
library(RODBC)
library(openxlsx)
library(gridExtra)
library(cowplot)
library(RColorBrewer)
library(lfe)
library(scales)

# clear
rm(list = ls())

# import data
df_ref <- read_dta("C:/lfp/data/intermediate_data/data_cleaned.dta")

# set specific data directories
directory_plot <- file.path("C:/lfp/plot/")
```
```{r}
df_local <- df_ref %>% filter(F2_D04==1)
sum(df_local$F2_D12>=4 & (df_local$F2_D11==4 | df_local$F2_D11==5)) / sum((df_local$F2_D11==4 | df_local$F2_D11==5))
```
```{r}
df_check <- df_ref %>% filter(F2_D10==1 & (F2_D11==4 | F2_D11==5) & F2_D04==2 & F2_D07>=16 & F2_D07<=64) 
nrow(df_check)
```
```{r}
# cleaning
df <- df_ref %>%
  mutate(year = ifelse(as.integer(year) >= 87, paste0("13", year), paste0("14", year))) %>%
  mutate(time = paste(year, "-", NobatAmargiri)) %>%
  rename(
    gender = F2_D04,
    age = F2_D07,
    citizenship = F2_D08,
    education_level = F2_D17,
    previous_residence=F2_D11,
    previous_residence_province=F2_D13
  ) %>% 
  mutate(gender=if_else(gender==1,"Male","Female")) %>%
  filter(age>=16 & age<=64, citizenship==1,urban_rural==1) %>%
  mutate(active = if_else(ActivityStatus == 1 | ActivityStatus == 2 , 1, 0)) %>%
  mutate(age_group = case_when(
    age >= 16 & age < 24 ~ "16-23",
    age >= 24 & age < 32 ~ "24-31",
    age >= 32 & age < 40 ~ "32-39",
    age >= 40 & age < 48 ~ "40-47",
    age >= 48 & age < 56 ~ "48-55",
    TRUE ~ "56+"
  )) %>%
  mutate(education_level = case_when(
      education_level == 11 ~ "literacy",
      education_level == 71 ~ "literacy",
      education_level == 21 ~ "high school",
      education_level == 31 ~ "high school",
      education_level == 41 ~ "diploma",
      education_level == 51 ~ "college",
      education_level == 52 ~ "college",
      education_level == 53 ~ "graduate level",
      education_level == 61 ~ "graduate level",
      education_level == 1 ~ "literacy",
      education_level == 2 ~ "high school",
      education_level == 3 ~ "high school",
      education_level == 4 ~ "diploma",
      education_level == 5 ~ "college",
      education_level == 6 ~ "college",
      education_level == 7 ~ "graduate level",
      education_level == 8 ~ "graduate level",
      # education_level == 9 ~ "other"
      TRUE ~ "other" # Keep the original value if no match
  ))   %>% mutate(migrated_recently = ifelse(F2_D10==1,1,0)) %>% 
      mutate(F2_D12 = as.numeric(F2_D12)) %>%
      mutate(why_migrated=case_when(
      (F2_D12 == 1 | F2_D12 == 2 | F2_D12 == 3) ~ "work",
      (F2_D12 == 4 | F2_D12 == 5) ~ "education",
      (F2_D12 == 6 | F2_D12 == 7) ~ "military",
      F2_D12 == 8 ~ "family",
      TRUE ~ "other")) %>%
select(pkey, year,NobatAmargiri,time,province_code,province_name,active,age_group,education_level,gender,previous_residence,previous_residence_province,why_migrated,active,age_group,IW_Yearly, ActivityStatus , sample_number, family_number, migrated_recently)
```

```{r}
province_lfp_level_female <- df %>% filter(gender=="Female") %>%
  group_by(province_code) %>%
  summarize(province_lfp = mean(active, na.rm = TRUE)) %>%
  mutate(province_lfp_rank = rank(-as.numeric(province_lfp), ties.method = "first")) %>% mutate(province_lfp_level=case_when(
    province_lfp_rank<=15 ~ "High",
    TRUE ~ "Low"
  )) %>% select(province_code,province_lfp_level) %>% rename(province_lfp_level_female=province_lfp_level)
```
```{r}
df <- df %>% mutate(original_province = if_else(previous_residence_province=="",province_code,previous_residence_province)) %>%
  left_join(province_lfp_level_female, by = c("original_province"="province_code")) %>% 
  rename(original_province_lfp_level_female=province_lfp_level_female) %>% 
  left_join(province_lfp_level_female, by = c("province_code"="province_code")) %>% 
  rename(current_province_lfp_level_female=province_lfp_level_female) %>% 
  filter(!((previous_residence==4 | previous_residence==5) & previous_residence_province==""))
```
```{r}
df <- df %>% mutate(migration =case_when(
  previous_residence==4 | previous_residence==5 ~ 1,
  TRUE ~ 0)) %>% 
  mutate(migration_type=case_when(
  migration==1 ~ paste(original_province_lfp_level_female,"-",current_province_lfp_level_female),
  TRUE ~ "no_migration"))
```

```{r}
stat_by_current_province_lfp_level <- df %>% filter(gender=="Female") %>% group_by(current_province_lfp_level_female) %>% summarize(ave_lfp=mean(active))
stat_by_current_original_province_lfp_level <- df %>% filter(gender=="Female") %>% filter(previous_residence==4 | previous_residence==5) %>% filter(why_migrated==8) %>% filter(!is.na(current_province_lfp_level_female) & !is.na(original_province_lfp_level_female)) %>% group_by(current_province_lfp_level_female,original_province_lfp_level_female) %>% summarize(ave_lfp=mean(active,na.rm=TRUE))
```
```{r}
# Create sample data
data <- data.frame(
  MainGroup = rep(c("Within High LFP Regions", "Within Low LFP Regions"), each = 3),
  SubCategory = rep(c("Non-immigrant", "Immigrant from Hight LFP Regions", "Immigrant from Low LFP Regions"), times = 2),
  Value = c(stat_by_current_province_lfp_level$ave_lfp[1],
            stat_by_current_original_province_lfp_level$ave_lfp[1],
            stat_by_current_original_province_lfp_level$ave_lfp[2],
            stat_by_current_province_lfp_level$ave_lfp[2],
            stat_by_current_original_province_lfp_level$ave_lfp[3],
            stat_by_current_original_province_lfp_level$ave_lfp[4])
)

# Convert to factors with specified order
data$MainGroup <- factor(data$MainGroup, levels = c("Within High LFP Regions", "Within Low LFP Regions"))
data$SubCategory <- factor(data$SubCategory, levels = c("Non-immigrant", "Immigrant from Hight LFP Regions", "Immigrant from Low LFP Regions"))

# Define custom colors using RColorBrewer's Set2 palette
custom_colors <- brewer.pal(n = 3, name = "Set2")

# Create the grouped bar chart with enhanced spacing and y-axis limits
grouped_bar_chart <- ggplot(data, aes(x = MainGroup, y = Value, fill = SubCategory)) +
  
  # Thinner bars with decreased position_dodge width
  geom_bar(stat = "identity", 
           position = position_dodge(width = 0.6),  # Decreased from 0.8 to 0.6
           width = 0.5) +                           # Increased from 0.4 to 0.5 for better visibility
  
  # Add percentage labels above the bars
  geom_text(aes(label = sprintf("%.2f%%", Value * 100)),
            position = position_dodge(width = 0.6),  # Match dodge width to geom_bar
            vjust = -0.5,
            size = 3) +
  
  # Apply the custom Set2 color palette
  scale_fill_manual(values = custom_colors) +
  
  # Define axis labels and plot title with updated y-axis label
  labs(title = "",
       x = "Main Group",
       y = "LFP (%)",  # Updated y-axis label
       fill = "") +
  
  # Set y-axis limits to 0% - 30% and format labels as percentages
  scale_y_continuous(
    limits = c(0, 0.3),  # Set y-axis from 0 to 0.3 (0% to 30%)
    labels = percent_format(accuracy = 1)  # Format labels as percentages with no decimal places
  ) +
  
  # Apply a minimalist and clean theme
  theme_minimal() +
  
  # Customize theme elements for a professional look
  theme(
    text = element_text(family = "Times New Roman", size = 12),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 12),
    axis.title.y = element_text(face = "bold", size = 12),
    axis.text.x = element_text(face = "bold", size = 10),
    axis.text.y = element_text(size = 10),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 10),
    legend.position = "bottom",
    
    # Fine-tune grid lines for better readability
    panel.grid.major = element_line(size = 0.1, color = "grey90"),
    panel.grid.minor = element_blank(),
    
    # Adjust plot margins for better spacing
    plot.margin = unit(c(1, 1, 1, 1), "cm")
  )

# Display the plot
print(grouped_bar_chart)
```
```{r}
# Set base levels for gender and migration
df$gender <- relevel(factor(df$gender), ref = "Male")
df$migration <- relevel(factor(df$migration), ref = "0")
df$migration_type <- relevel(factor(df$migration_type), ref = "no_migration")
df$education_level <- relevel(factor(df$education_level), ref = "literacy")
df_local <- df %>% filter(education_level!="other")

# Fit the model
model <- felm(active ~ gender + migration + gender*migration + education_level + age_group | province_code + time, data = df_local)

# Full model summary, including coefficients, p-values, and significance stars
summary(model)

# If you want only the specific coefficients with their full details:
# Extract the coefficient table
coef_table <- summary(model)$coefficients

# Filter out the rows you are interested in: gender, migration, and their interaction
coef_of_interest <- coef_table[grep("gender|migration", rownames(coef_table)), ]

# Print the selected coefficients, p-values, and significance levels
coef_of_interest

```
```{r}
df_local <- df %>% 
  filter(gender == "Female") %>% 
  filter(!(migration_type %in% c("NA - High", "NA - Medium", "NA - Low"))) 

# Fit the model
model <- felm(active ~ migration_type+age_group+education_level | time, data = df_local)

# Full model summary, including coefficients, p-values, and significance stars
summary(model)

# If you want only the specific coefficients with their full details:
# Extract the coefficient table
coef_table <- summary(model)$coefficients

# Filter out the rows you are interested in: gender, migration, and their interaction
coef_of_interest <- coef_table[grep("gender|migration", rownames(coef_table)), ]

# Print the selected coefficients, p-values, and significance levels
coef_of_interest
```
```{r}
# Fit the model
model <- felm(active ~ migration_type+age_group+education_level | original_province+ time, data = df_local)

# Full model summary, including coefficients, p-values, and significance stars
summary(model)

# If you want only the specific coefficients with their full details:
# Extract the coefficient table
coef_table <- summary(model)$coefficients

# Filter out the rows you are interested in: gender, migration, and their interaction
coef_of_interest <- coef_table[grep("gender|migration", rownames(coef_table)), ]

# Print the selected coefficients, p-values, and significance levels
coef_of_interest
```