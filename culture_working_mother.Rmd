<<<<<<< HEAD
---
  title: "Cleaning"
author: "Marziyeh Aghaei"
date: "2024-07-22"
output:
  html_document: 
  code_folding: show
   number_sections: yes
   toc: yes
   toc_depth: 2
   toc_float: yes
---
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r,message = FALSE}
# packages
require(tidyverse)
require(fixest)
require(stargazer)
require(haven)
library(usethis)
library(dplyr)
library(foreign)
library(gridExtra)
library(ggplot2)
library(openxlsx)
library(RODBC)
library(openxlsx)
library(gridExtra)
library(cowplot)
library(RColorBrewer)

# clear
rm(list = ls())

# import data
df_ref <- read_dta("C:/lfp/data/intermediate_data/data_cleaned.dta")

# set specific data directories
directory_plot <- file.path("C:/lfp/plot/")
```
```{r}
# cleaning
# cleaning
df <- df_ref %>%
  mutate(year = ifelse(as.integer(year) >= 87, paste0("13", year), paste0("14", year))) %>%
  mutate(time = paste(year, "-", NobatAmargiri)) %>%
  rename(
    gender = F2_D04,
    age = F2_D07,
    citizenship = F2_D08,
    education_level = F2_D17,
    family_relation = F2_D03,
  ) %>% 
  mutate(gender=if_else(gender==1,"Male","Female")) %>%
  filter(age>=16 & age<=64, citizenship==1,urban_rural==1) %>%
  mutate(active = if_else(ActivityStatus == 1 | ActivityStatus == 2 , 1, 0)) %>%
  mutate(age_group = case_when(
    age >= 16 & age < 24 ~ "16-23",
    age >= 24 & age < 32 ~ "24-31",
    age >= 32 & age < 40 ~ "32-39",
    age >= 40 & age < 48 ~ "40-47",
    age >= 48 & age < 56 ~ "48-55",
    TRUE ~ "56+"
  )) %>%
  mutate(education_level = case_when(
      education_level == 11 ~ "literacy",
      education_level == 71 ~ "literacy",
      education_level == 21 ~ "high school",
      education_level == 31 ~ "high school",
      education_level == 41 ~ "diploma",
      education_level == 51 ~ "college",
      education_level == 52 ~ "college",
      education_level == 53 ~ "graduate level",
      education_level == 61 ~ "graduate level",
      education_level == 1 ~ "literacy",
      education_level == 2 ~ "high School",
      education_level == 3 ~ "high School",
      education_level == 4 ~ "diploma",
      education_level == 5 ~ "college",
      education_level == 6 ~ "college",
      education_level == 7 ~ "graduate level",
      education_level == 8 ~ "graduate level",
      # education_level == 9 ~ "other"
      TRUE ~ "other" # Keep the original value if no match
  ))  
# select(pkey, year,NobatAmargiri,time,province_code,province_name,active,age_group,education_level,gender,previous_residence,previous_residence_province,why_changed_residence,active,age_group,IW_Yearly, ActivityStatus , sample_number, family_number)

```
```{r}
df <- df %>%
  mutate(
    F3_D15SAL = as.numeric(F3_D15SAL, na.rm = TRUE),
    F3_D37SAL = as.numeric(F3_D37SAL, na.rm = TRUE)
  )
```
```{r}

df <- df %>%
  mutate(wife = if_else(((family_relation == 1 & gender == "Female") | (family_relation == 2 & gender == "Female")), 1, 0)) %>%
  group_by(pkey) %>%
  mutate(wife_lfp_history = if_else(wife == 1, max(F3_D15SAL, F3_D37SAL, na.rm = TRUE), 0)) %>%
  mutate(wife_lfp_history = max(wife_lfp_history, na.rm = TRUE),
    wife_lfp_history = if_else(is.finite(wife_lfp_history), wife_lfp_history, NA)) %>%
  filter(any(wife == 1) | any(family_relation == 3 & gender == "Female")) %>%
  ungroup()

```
```{r}
# Step 1: Ensure F3_D15SAL and F3_D37SAL are numeric
df <- df %>%
  mutate(
    F3_D15SAL = as.numeric(F3_D15SAL),
    F3_D37SAL = as.numeric(F3_D37SAL)
  )
```

```{r}
# Step 2: Data Transformation Pipeline
df_local <- df %>%
  # Create 'wife' variable
  mutate(
    wife = if_else(
      (family_relation %in% c(1, 2) & gender == "Female"),
      1,
      0,
      missing = 0
    )
  ) %>%
  
  # Group by 'pkey' for group-wise operations
  group_by(pkey) %>%
  
  # Calculate 'wife_lfp_history'
  mutate(
    wife_lfp_history = if_else(
      wife == 1,
      pmax(F3_D15SAL, F3_D37SAL, na.rm = TRUE),
      0
    ),
    # Replace '-Inf' with 0
    wife_lfp_history = if_else(
      is.finite(wife_lfp_history),
      wife_lfp_history,
      0
    ),
    # Set 'wife_lfp_history' to the group's maximum value
    wife_lfp_history = max(wife_lfp_history, na.rm = TRUE)
  ) %>%
  
  # Filter groups based on conditions
  filter(
    any(wife == 1) | any(family_relation == 3 & gender == "Female")
  ) %>%
  
  # Ungroup the data
  ungroup() %>%
  
  # Categorize 'wife_lfp_history' into groups
  mutate(
    wife_lfp_history_group = case_when(
      wife_lfp_history > 0 & wife_lfp_history < 5 ~ "Less than 5 years",
      wife_lfp_history >= 5 & wife_lfp_history < 10 ~ "5-10 years",
      wife_lfp_history >= 10 & wife_lfp_history < 20 ~ "10-20 years",
      wife_lfp_history >= 20 ~ "20+ years",
      TRUE ~ "Never worked"  # Handles any remaining cases
    )
  )

```

```{r}

df_local <- df_local %>%
  filter(gender == "Female" & family_relation==3) %>% filter(year==1401)

df_summary <- df_local %>%
  group_by(wife_lfp_history_group) %>%
  summarise(
    total_individuals = n(),
    active_count = sum(active == 1, na.rm = TRUE),
    share_active = mean(active == 1, na.rm = TRUE) * 100  # Percentage
  ) %>%
  arrange(desc(share_active))  # Optional: Arrange in descending order of share_active

# View the summary
print(df_summary)


```
```{r}
df_reg <- df_local %>%
  filter(gender == "Female" & family_relation==3)

df_reg$wife_lfp_history_group <- relevel(factor(df_reg$wife_lfp_history_group), ref = "Never worked")
df_reg$education_level <- relevel(factor(df_reg$education_level), ref = "literacy")

# Fit the model
model <- felm(active ~   wife_lfp_history_group + education_level + age_group | province_code + time, data = df_reg)

# Full model summary, including coefficients, p-values, and significance stars
summary(model)


```
